
# CBC-MAC II

* This exercise covers the exploitation of an application using CBC-MAC when an attacker has control over the `IV`

## Introduction

* This course details the exploitation of a weakness in the authentication of a website. The website uses CBC-MAC to ensure the integrity of the username. However, the authentication just "signs" the username provided and send it as a cookie. This website also uses an Initialisation Vector (IV) to sign the cookie, the IV is sent back to users as a cookie.


* If you want to do it by yourself, you can follow the following steps:

    * keep in mind that you need to work modulo the block-size.
    * create a user with a username that looks like the desired username.
    * tamper with the IV to become administrator.

## CBC-MAC and Initialisation Vector

* Proper implementation of CBC-MAC use a NULL Initialisation Vector: a string of block-size that only contains NULL bytes. Having an hardcoded IV doesn't impact the security of the implementation (quite the opposite). The danger with using a specific IV is that it will often be controlled by the attacker and completely breaks the integrity of the CBC-MAC signature.

## The attack
### Theory

* If you can modify the IV, you are able to easily change the first block of the cleartext without impacting the signature. 

* The only thing you need to keep in mind is that a XOR is used between the IV and the first block. Any modification of the cleartext will need to be XOR'ed with the IV. So if you change the value of the first byte of the first block from x to y, you will need to change the first byte of the IV by XORing with `x^y`.

### Implementation

* To get this attack working, you first need to login with a username very similar to administrator (especially length-wise). Once you are logged in, you should get a signature and an IV (both as cookie). Once you get both values, you just need to compute a XOR of the first block of your username against the first block of administrator. Once you get that value, you can just XOR it with the IV and use the result as the new IV.

## Conclusion

* This exercise showed you how you can forge signatures by playing with the IV if the site provides it to you. It showed you that using CBC-MAC and having the IV controlled by users completely breaks the security of the signature. I hope you enjoyed learning with PentesterLab.


* You can access this exercise using the following URL: http://ptl-8481fa79-e5524051.libcurl.so/ 

* just run the `solver.py` to get the key.
