# Cipher block chaining

## Introduction

* This course details the exploitation of a weakness in the authentication of a PHP website. The website uses CBC to encrypt information provided by users and use this information to ensure authentication. We will see how this behaviour can impact the authentication and how it can be exploited.

* If you feel confident, you can try to do this exercise without following the course, then you can come back to the course to read some details and tips. If you want to do it by yourself, you can follow the following steps:

    * create a user with a username similar to the desired username.

    * modify the first bytes of the cookie to become the username you are trying to become.

## CBC

* CBC is an encryption mode in which the message is splitted into blocks of `X` bytes length and each block is encrypted separetely using a key.

* The following schema (source: [Wikipedia](https://en.wikipedia.org/wiki/Block_cipher_mode_of_operation)) explains this method:

![cbc encryption ](https://github.com/tejeshreddymeka/PentesterLabNotes/blob/master/images/8_3_CBC_encryption.png)


* We are going to focus on the first block as with our current username, we only need one block. The schema below illustrates the decryption process with an arbitrary IV:
![cbc encryption 1](https://github.com/tejeshreddymeka/PentesterLabNotes/blob/master/images/8_3_cbc-1.png)

* If you create a user `bdmin`, this is what you get during the decryption:

![cbc encryption 2](https://github.com/tejeshreddymeka/PentesterLabNotes/blob/master/images/8_3_cbc-2.png)

* Now, we want to tamper with the IV (since it gets xored with the result of the decryption) to become `admin`:

![cbc encryption 3](https://github.com/tejeshreddymeka/PentesterLabNotes/blob/master/images/8_3_cbc-3.png)

## The attack

* To perform this attack, you will need to automate it. To get started, create a simple script that sends your current cookie to the server and ensure you're still logged in.

* Once you have that working, it's time to tamper with the IV.

* Here, you will need to work out the block size. Based on the size of the cookie, it's very likely that the block size is `8` bytes. However, you can play with the size of the username to detect this (like we did in the ECB exercise.

* Once you have the block size, it's likely that the first block is the IV.

* Keep in mind that not all CBC implementation will give you access to the IV. In some cases, the IV will be hardcoded.

* After decoding the cookie, you can then extract the IV, and brute-force the byte (first byte of the IV if you used a username like bdmin or xdmin) you need to change until you become admin. In order to limit the amount of brute-force you will need, it's recommended to use a username like `bdmin` or `zdmin`. This will allow you to only have to tamper with the first byte to become admin.

* You can also perform the same attack without using bruteforce by computing what the `XOR` between the first letter of the username you want and the first letter of the username you use and apply this (`XOR`) to the first byte of the `IV`.

## Conclusion

* This exercise showed you how you can tamper encrypted information without decrypting them and use this behaviour to gain access to other accounts. It showed you that encryption can not be used as a replacement to signature and how it's possible to use CBC encryption to get control on the decrypted information.

* Here the cookie is set as follow
```
cookie = urlencode( base64encode( IV + Chiphertext))
```
* you register a user with username `mdmin` and you will get the cookie 

* after url decoding the cookie and base64 decoding you will find that the first byte is `0x3f`

* So if you set the first byte of `IV` with ` 0x3f ^ a ^ m ` after decription the user will be treated as `admin` instead of `mdmin`.

```python
 >>> New_IV_First_Byte = "{:x}".format(0x3f ^ ord('a') ^ ord('m'))
 '33'
```

* So replace the first byte of `IV` (i.e, `0x3f` with `0x33`) and base64 encode and url encode and send it to the server , then you will be logged in as admin and you will get the key.
