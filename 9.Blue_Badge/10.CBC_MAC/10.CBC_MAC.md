
# CBC MAC

* This exercise covers the exploitation of signature of non-fixed size messages with CBC-MAC

## Introduction

* This course details the exploitation of a weakness in the authentication of a website. The website uses CBC-MAC to ensure the integrity of the username. However, the authentication just `signs` the username provided and send it as a cookie. We will see how this behaviour can impact the authentication and how it can be exploited.

* If you feel confident, you can try to do this exercise without following the course, then you can come back to the course to read some details and tips. If you want to do it by yourself, you can follow the following steps:

    * keep in mind that you need to work modulo the block-size.
    * create a user with a username that starts with the desired username.
    * create another user with a username that can be combined with the first username to get logged in as `administrator`.

## CBC-MAC

* CBC-MAC is a method to ensure integrity of a message by encrypting it using CBC mode and keeping the last encrypted block as `signature`. This ensures that a malicious user can not modify any part of the data without having to change the signature. The key used for the `encryption` ensures that the signature can't be guessed.

* However, when using CBC-MAC, the developer needs to be very careful if the message are not of `fixed length`. In this example, we will use the fact that there is no protection in place to get the application to sign two messages and build another message by concatenating the two messages.

## The attack
### Theory

* With CBC-MAC, we can generate two signatures `t` and `t'` for the messages `m` and `m'`. By using `m` and `m'` we can forge another message `m''` that will have the same signature as `m'` (t'). One thing to keep in mind is that the recommended way to use CBC-MAC is to use a `NULL` IV.

* To keep things simple, we are going to work on a single block for each message.

* We can see below how signing both messages works (__NB__: both signatures are completely independent from each other):

![9_10_cbc-mac-1.png](https://github.com/tejeshreddymeka/PentesterLabNotes/blob/master/images/9_10_cbc-mac-1.png)

* If we try to concatenate those messages, the signature is no longer valid (since `t` is now the IV for the second block where it was only `NULL` before):

![9_10_cbc-mac-2.png](https://github.com/tejeshreddymeka/PentesterLabNotes/blob/master/images/9_10_cbc-mac-2.png)

* However, if we XOR `m'` and `t`, the signature is now `t'`:

![9_10_cbc-mac-3.png](https://github.com/tejeshreddymeka/PentesterLabNotes/blob/master/images/9_10_cbc-mac-3.png)

### Implementation

* Based on the size of the signature, we can guess that the block size is likely to be `8`. With this information, we will split administrator:
```
    administ
    rator\00\00\00
```

* We can trivially generate the signature for the first block, by just logging in and retrieving the signature `t`.

* For the second block, we want the `m' XOR t` to be equal to `rator\00\00\00`. So to generate the second username we will need to XOR `rator\00\00\00` with `t` (since the application will sign it with a `NULL` IV instead of `t`). Once we have this value, we can get the signature `t'`.

* Finally, we just need to concatenate `m` and `m'` to get administrator and use `t'` as signature.

## Conclusion

* This exercise showed you how you can forge signatures by getting the website to provide you the building blocks to create it. It showed you that using CBC-MAC without some restrictions can provide break the security of the implementation. I hope you enjoyed learning with PentesterLab.


* You can access this exercise using the following URL: http://ptl-8ff4ac6b-43d4ac51.libcurl.so/

* you run `solver.py` to get the key.
